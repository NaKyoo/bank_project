name: CI Backend - Tests Automatis√©s

# ==============================================================================
# NOM DU WORKFLOW : CI Backend - Tests Automatis√©s
# ==============================================================================
# DESCRIPTION :
# Ce pipeline d'Int√©gration Continue (CI) automatise l'ex√©cution des tests
# unitaires √† chaque push sur n'importe quelle branche du d√©p√¥t.
# En cas d'√©chec des tests, une issue GitHub est automatiquement cr√©√©e.
#
# OBJECTIFS (User Story 2) :
# "Ex√©cution automatique des tests avec rapport"
# "En tant que D√©veloppeur, je veux √™tre notifi√© si une modification a un impact n√©gatif"
# ==============================================================================

# ------------------------------------------------------------------------------
# D√âCLENCHEUR (TRIGGER)
# ------------------------------------------------------------------------------
# Le workflow se d√©clenche automatiquement √† chaque push sur toutes les branches
on: [push]

# ------------------------------------------------------------------------------
# PERMISSIONS
# ------------------------------------------------------------------------------
# D√©finit les permissions accord√©es au token GITHUB_TOKEN pour ce workflow.
# Ces permissions sont n√©cessaires pour que le workflow puisse cr√©er des issues
# automatiquement en cas d'√©chec des tests.
permissions:
  issues: write      # Permet de cr√©er et modifier des issues
  contents: read     # Permet de lire le contenu du d√©p√¥t

jobs:
  test:
    # --------------------------------------------------------------------------
    # JOB : TESTS UNITAIRES
    # --------------------------------------------------------------------------
    # Ce job configure l'environnement Python, installe les d√©pendances
    # et ex√©cute les tests avec pytest.
    # Environnement d'ex√©cution : Derni√®re version stable d'Ubuntu.
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------------------
      # √âTAPE 1 : R√âCUP√âRATION DU CODE
      # ------------------------------------------------------------------------
      # Clone le code du d√©p√¥t dans l'environnement virtuel GitHub Actions
      - name: Checkout code
        uses: actions/checkout@v4

      # ------------------------------------------------------------------------
      # √âTAPE 2 : CONFIGURATION DE PYTHON 3.10
      # ------------------------------------------------------------------------
      # Installe et configure Python version 3.10 pour garantir la compatibilit√©
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # ------------------------------------------------------------------------
      # √âTAPE 3 : INSTALLATION DES D√âPENDANCES
      # ------------------------------------------------------------------------
      # 1. Met √† jour pip vers la derni√®re version
      # 2. Installe toutes les d√©pendances list√©es dans requirements.txt
      #    (incluant pytest et httpx pour les tests)
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ------------------------------------------------------------------------
      # √âTAPE 4 : EX√âCUTION DES TESTS AVEC PYTEST
      # ------------------------------------------------------------------------
      # Configure le PYTHONPATH pour inclure le dossier 'src' afin que
      # les imports de modules fonctionnent correctement.
      # Lance pytest pour ex√©cuter tous les tests du projet.
      - name: Run tests with pytest
        run: |
          export PYTHONPATH=$PYTHONPATH:src
          pytest

      # ------------------------------------------------------------------------
      # √âTAPE 5 : CR√âATION D'UNE ISSUE GITHUB EN CAS D'√âCHEC
      # ------------------------------------------------------------------------
      # Cette √©tape s'ex√©cute UNIQUEMENT si les tests √©chouent (if: failure())
      # Elle cr√©e automatiquement une issue GitHub avec tous les d√©tails de l'√©chec.
      #
      # AVANTAGES :
      # - Aucune configuration de secrets n√©cessaire (utilise ${{ secrets.GITHUB_TOKEN }})
      # - Notification native GitHub (email automatique aux watchers du d√©p√¥t)
      # - Tra√ßabilit√© compl√®te dans l'onglet Issues
      # - Lien direct vers les logs d'ex√©cution
      #
      # Le token GITHUB_TOKEN est automatiquement fourni par GitHub Actions,
      # aucune configuration manuelle n'est requise.
      - name: Create issue on test failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `‚ùå √âchec des tests CI - ${context.ref.replace('refs/heads/', '')}`,
              body: [
                '## üö® √âchec des Tests Unitaires',
                '',
                'Les tests automatis√©s ont √©chou√© lors du dernier push.',
                '',
                '### üìã Informations',
                '',
                '| √âl√©ment | Valeur |',
                '|---------|--------|',
                `| **Branche** | \`${context.ref.replace('refs/heads/', '')}\` |`,
                `| **Commit** | \`${context.sha.substring(0, 7)}\` |`,
                `| **Auteur** | @${context.actor} |`,
                `| **Workflow** | ${context.workflow} |`,
                `| **Run ID** | ${context.runId} |`,
                '',
                '### üìù Message du commit',
                '',
                '```',
                context.payload.head_commit?.message || 'N/A',
                '```',
                '',
                '### üîó Liens utiles',
                '',
                `- [Voir les logs d'ex√©cution](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
                `- [Voir le commit](https://github.com/${context.repo.owner}/${context.repo.repo}/commit/${context.sha})`,
                '',
                '### ‚úÖ Actions √† effectuer',
                '',
                '1. Consulter les logs d\'ex√©cution pour identifier l\'erreur',
                '2. Corriger le code en cons√©quence',
                '3. Pousser les corrections sur la branche',
                '4. Fermer cette issue une fois les tests pass√©s',
                '',
                '---',
                '*Cette issue a √©t√© cr√©√©e automatiquement par le workflow CI/CD.*'
              ].join('\n'),
              labels: ['bug', 'CI/CD', 'tests']
            });
            console.log('Issue cr√©√©e : #' + issue.data.number);


  deploy:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@v5

        - name: Login to Docker Hub
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_PASSWORD }}

        - name: Build and push Docker image
          uses: docker/build-push-action@v5
          with:
            context: .
            push: true
            tags: nolent77/bank-backend:0.0.2